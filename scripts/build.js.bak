import fs from "fs";
import path from "path";

const ROOT = process.cwd();
const DATA = path.join(ROOT, "data");
const TPL = path.join(ROOT, "templates");
const OUT = path.join(ROOT, "public", "_gen");

const site = JSON.parse(fs.readFileSync(path.join(DATA, "site.json")));
const states = JSON.parse(fs.readFileSync(path.join(DATA, "states.json")));

const fmt = n => `$${Number(n).toFixed(2)}`;

function clean(dir){
  if(fs.existsSync(dir)) fs.rmSync(dir, { recursive:true, force:true });
  fs.mkdirSync(dir, { recursive:true });
}

function write(file, content){
  fs.mkdirSync(path.dirname(file), { recursive:true });
  fs.writeFileSync(file, content, "utf8");
}

function page({ title, desc, body }){
  return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${title}</title>
<meta name="description" content="${desc}">
<link rel="stylesheet" href="/_gen/styles.css">
</head>
<body>
<a class="skip-link" href="#main">Skip to content</a>

<header class="site-header">
  <div class="container header-row">
    <div class="brand">
      <img src="${site.logoPath}" class="brand__logo" alt="${site.siteName}">
      <span>${site.siteName}</span>
    </div>
    <nav class="nav">
      <a href="/_gen/">Home</a>
      <a href="/_gen/category/divorce-kits/">Divorce Kits</a>
    </nav>
  </div>
</header>

<main id="main" class="site-main">
${body}
</main>

<footer class="site-footer">
  <div class="container fineprint">
    <p>${site.legal.footerDisclaimerLine1}</p>
    <p>${site.legal.footerDisclaimerLine2}</p>
    <p>${site.legal.footerDisclaimerLine3}</p>
  </div>
</footer>
</body>
</html>`;
}

function productCard(state, type){
  const p = site.products[type];
  const img = state.images[type];
  return `
<div class="product-card">
  <div class="product-card__body">
    <h2 class="product-card__title">${p.nameTemplate.replace("{STATE}", state.name)}</h2>
    <div class="product-card__meta">
      <div class="price">${fmt(p.price)}</div>
      <div class="pill">${p.label}</div>
    </div>
    <p>${p.short.replace("{STATE}", state.name)}</p>
    <a class="btn btn--primary" href="${state.stripeLinks[type]}">${p.buyText}</a>
  </div>
</div>`;
}

function buildHome(){
  write(
    path.join(OUT, "index.html"),
    page({
      title: `${site.siteName} â€“ State-Specific Divorce Kits`,
      desc: "Court-approved uncontested divorce forms with clear instructions. Flat pricing. No subscriptions.",
      body: `
<section class="section hero">
  <div class="container hero-grid">
    <div>
      <h1>State-Specific Divorce Kits</h1>
      <p class="lead">Clear instructions. Flat pricing. No subscriptions.</p>
      <div class="hero-badges">
        <span class="badge">All 50 States</span>
        <span class="badge">Uncontested Divorce</span>
        <span class="badge">Fee Waiver Included</span>
      </div>
      <div class="hero-cta">
        <a class="btn btn--primary" href="/_gen/category/divorce-kits/">Browse Divorce Kits</a>
      </div>
    </div>
  </div>
</section>`
    })
  );
}

function buildCategory(){
  write(
    path.join(OUT, "category/divorce-kits/index.html"),
    page({
      title: "Divorce Kits by State | Uncontested Divorce Forms",
      desc: "Uncontested divorce forms for all 50 states. With or without children. Flat pricing.",
      body: `
<section class="section">
  <div class="container">
    <h1>Divorce Kits by State</h1>
    <div class="state-grid">
      ${states.map(s=>`
        <a class="state-tile" href="/_gen/category/divorce-kits/${s.slug}/">${s.name}</a>
      `).join("")}
    </div>
  </div>
</section>`
    })
  );
}

function buildState(state){
  write(
    path.join(OUT, `category/divorce-kits/${state.slug}/index.html`),
    page({
      title: `${state.name} Divorce Kits | Uncontested Divorce Forms`,
      desc: `Uncontested divorce forms for ${state.name}. Court-approved. Flat pricing. Fee waiver included.`,
      body: `
<section class="section">
  <div class="container">
    <h1>${state.name} Divorce Kits</h1>
    <p class="lead">${state.filingFeeText}</p>

    <div class="product-grid">
      ${productCard(state, "withoutChildren")}
      ${productCard(state, "withChildren")}
    </div>
  </div>
</section>`
    })
  );
}

function build(){
  clean(OUT);
  fs.copyFileSync(path.join(ROOT,"styles.css"), path.join(OUT,"styles.css"));

  buildHome();
  buildCategory();
  states.forEach(buildState);
}

build();